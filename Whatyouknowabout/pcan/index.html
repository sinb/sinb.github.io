<!DOCTYPE HTML>
<html>
<head>
<meta property="wb:webmaster" content="bcd8d91e6f53648a" />
<meta property="qc:admins" content="357067532626714052617" />
<meta name="baidu-site-verification" content="xdZ6LobkoN" />
  <meta charset="utf-8">
  
  <title>PCANet代码分析 | Amnesia&#39;s blog</title>
  <meta name="author" content="Amnesia">
  
  <meta name="description" content="">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="PCANet代码分析"/>
  <meta property="og:site_name" content="Amnesia&#39;s blog"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/css/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="Amnesia&#39;s blog" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-54965599-1']);
  
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>



</head>


<body>

<script>
  window.fbAsyncInit = function() {
    FB.init({
      appId      : '619735811500878',
      xfbml      : true,
      version    : 'v2.4'
    });
  };

  (function(d, s, id){
     var js, fjs = d.getElementsByTagName(s)[0];
     if (d.getElementById(id)) {return;}
     js = d.createElement(s); js.id = id;
     js.src = "//connect.facebook.net/en_US/sdk.js";
     fjs.parentNode.insertBefore(js, fjs);
   }(document, 'script', 'facebook-jssdk'));
</script>

  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">Amnesia&#39;s blog</a></h1>
  <h2><a href="/">I&#39;ll be your mirror</a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">主页</a></li>
    
      <li><a href="/categories/Life">生活</a></li>
    
      <li><a href="/categories/Whatyouknowabout">科普</a></li>
    
      <li><a href="/categories/Courseranote">Coursera笔记</a></li>
    
      <li><a href="/categories/Artworks">Artworks</a></li>
    
      <li><a href="/links">友链</a></li>
    
      <li><a href="/about">关于</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div></header>
    <script type="text/javascript"
   src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
	
  <script src="https://raw.github.com/processing-js/processing-js/v1.4.8/processing.min.js" type="text/javascript"></script> 
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper"><article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2015-10-25T12:45:00.000Z"><a href="/Whatyouknowabout/pcan/">2015-10-25</a></time>
      
      
  
    <h1 class="title">PCANet代码分析</h1>
  

    </header>
    <div class="entry">
      
        <hr>
<a id="more"></a>
<p>这段时间的工作内容从模式识别转了图像low-level处理,方法也换了,从神经网络换了词典学习,甚至到了spatial domain处理.这一换虽然是折腾,但词典学习完全颠覆了我对深度学习和神经网络的理解,我也产生了我的第一个想法,也算有收获.不过上周一查新,有篇PCANet和我的想法很像,这文章很新,预发了15年12月的TIP,仔细一看又是Yi Ma大神的挂名.PCANet自称deep learning new baseline,简单还准确率高.看完文章,我甚至觉得这想法就不应该让我想出来,就应该让Yi Ma的团队想出来去做,他们的实验做的太好了,又会写.不过既然是大牛挖的坑就跳吧,目测能改进(人家本来就自称baseline..).总觉得我能不能毕业就靠这篇文章了.</p>
<h2 id="Two_stage_PCA">Two stage PCA</h2><h3 id="Stage_1">Stage 1</h3><p><img src="/images/pcan/1.png" alt=""><br>重点就是这两步PCA,计算PCA然后对图像片计算PCA系数.<br>训练样本1000张32*32*3的图片.第一步取40个PCA向量,第二步取8个PCA向量.<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">V&#123;stage&#125; = P<span class="built_in">CA_FilterBank</span>(OutImg, P<span class="built_in">CANet</span><span class="variable">.PatchSize</span>(stage), P<span class="built_in">CANet</span><span class="variable">.NumFilters</span>(stage));</span><br></pre></td></tr></table></figure></p>
<p>比如对于stage 1, 上面的输入OutImg是1000个32*32*3的图像片.<br>PCA需要在小片上计算,一个小片5*5*3=75维.所以所有小片组成的样本的协方差矩阵75*75,PCA特征向量算出来也应该是75*75.<br><figure class="highlight matlab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%PCA_FilterBank.m</span></span><br><span class="line">Rx = <span class="built_in">zeros</span>(NumChls\*PatchSize^<span class="number">2</span>,NumChls\*PatchSize^<span class="number">2</span>); <span class="comment">% sum covariance</span></span><br><span class="line"><span class="keyword">for</span> <span class="built_in">i</span> = RandIdx <span class="comment">%1:ImgZ</span></span><br><span class="line">    im = im2col_mean_removal(InImg<span class="cell">&#123;i&#125;</span>,<span class="matrix">[PatchSize PatchSize]</span>); <span class="comment">% collect all the patches of the ith image in a matrix, and perform patch mean removal</span></span><br><span class="line">    Rx = Rx + im\*im<span class="operator">'</span>; <span class="comment">% sum of all the input images' covariance matrix</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure></p>
<p>里面有个有用的函数,im2col_mean_removal,找到一张大图里所有的小片并且去均值,这里的返回应该是75*784,75是一个小片的维度,784=(32-5+1)^2.<br>Stage 1里得到75x40的PCA基.然后是投影.<br>具体做法,对一张32x32x3的大图先补0变成36x36x3,目的是使计算投影后的结果和原图一样大(只不过变成了32x32x1).<br><figure class="highlight matlab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%PCA_output.m</span></span><br><span class="line">    <span class="keyword">for</span> <span class="built_in">j</span> = <span class="number">1</span>:NumFilters</span><br><span class="line">        cnt = cnt + <span class="number">1</span>;</span><br><span class="line">        OutImg<span class="cell">&#123;cnt&#125;</span> = <span class="built_in">reshape</span>(V(:,<span class="built_in">j</span>)<span class="operator">'</span>*im,ImgX,ImgY);  <span class="comment">% convolution output</span></span><br><span class="line">    <span class="keyword">end</span></span><br></pre></td></tr></table></figure></p>
<p>这个循环对一张大图,计算了40个PCA的投影.V(:,j)是一个PCA基,im的维度是75x1024,是36x36的图像上所有的5x5x3片,V(:,j)’*im算出了这1024个片(位置)在这个基向量上的投影.<br><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">OutImgIdx = kron<span class="list">(<span class="keyword">InImgIdx</span>,ones<span class="list">(<span class="keyword">NumFilters</span>,<span class="number">1</span>)</span>)</span><span class="comment">;</span></span><br></pre></td></tr></table></figure></p>
<p>这样一张32x32x3的大图变成了40张32x32的图.OutImgIdx用来记录这个对应关系(从1变40的关系).</p>
<h3 id="Stage_2">Stage 2</h3><p>经过第一步,1000张32x32x3变成了40000张32x32x1,作为新的输入.Stage 2的PCA取前8个,并且由于现在不是3通道了,所以PCA基算出是25x8.<br>Stage 2计算出的投影就是在做feature extraction.<br>这一步虽然有40000张输入,但应该对应到最初的input layer上去,也就是一次计算40张32x32,这40张对应着一张32x32x3.8个PCA基,所以用PCA_output的输出是320个32x32,都对应与最初的一张输入图像.</p>
<h2 id="特征计算">特征计算</h2><p>一张图输入经过stage 1的40个基变为40张特征图, 每张特征图经过stage 2的8个基变为8张图片.<br>这8张图片,首先经过Heaviside step变成01图,然后从每个像素位置看,都是一个8位二进制数,这样8张又成了一张,每个像素位置处是一个范围在\([0, 2^8-1]\)的数.于是输出层的图像数又和stage 1的输出一样了.<br>1-&gt;40-&gt;320-&gt;40.</p>
<p><center><img src="/images/pcan/2.png"></center><br>对输出层的每一张图,把它分成B个blocks,每个blocks里做bins为2^8-1的histogram,然后把这B个blocks的histogram连成一个向量输出.这张图与这个式子对应.</p>
<p><center><img src="/images/pcan/3.png"></center></p>
<p><center><img src="/images/pcan/4.png"></center><br>Blocks之间可以重合.<br>比如block大小8,重合50%,步长就是4.32x32的图里共有ceil((32-8+1)/4)^2=49个8x8的block.<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stride = round((1-PCANet.BlkOverLapRatio)*PCANet.HistBlockSize); &#10;blkwise_fea = sparse(histc(im2col_general(T,PCANet.HistBlockSize,...&#10;  stride),(0:2^PCANet.NumFilters(end)-1)&#39;));</span><br></pre></td></tr></table></figure></p>
<p>上面两行做了histogram统计,得到49个256x1的统计向量.这一步再用[4 2 1]的spatial pyramid pooling,变成21x256.40张图连成一个21x256x40的向量,这就是一张图的最终特征了.</p>

      
    </div>
    <footer>
      
        
  
  <div class="categories">
    <a href="/categories/Whatyouknowabout/">Whatyouknowabout</a>
  </div>

        
  
  <div class="tags">
    <a href="/tags/Deep-Learning/">Deep Learning</a>, <a href="/tags/PCA/">PCA</a>, <a href="/tags/Paper/">Paper</a>
  </div>

        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


<section id="comment">
<!-- Duoshuo Comment BEGIN -->
	<div class="ds-thread"></div>
<script type="text/javascript">
var duoshuoQuery = {short_name:"sinb"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = 'http://static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		|| document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
<!-- Duoshuo Comment END -->
</section>

</div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="搜尋">
    <input type="hidden" name="q" value="site:sinb.github.io">
  </form>
</div>

  
<div class="widget tag">
  <h3 class="title">分類</h3>
  <ul class="entry">
  
    <li><a href="/categories/Artworks/">Artworks</a><small>8</small></li>
  
    <li><a href="/categories/Courseranote/">Courseranote</a><small>5</small></li>
  
    <li><a href="/categories/Life/">Life</a><small>7</small></li>
  
    <li><a href="/categories/Whatyouknowabout/">Whatyouknowabout</a><small>28</small></li>
  
  </ul>
</div>


  
<div class="widget tag">
  <h3 class="title">標籤</h3>
  <ul class="entry">
  
    <li><a href="/tags/8bit/">8bit</a><small>1</small></li>
  
    <li><a href="/tags/Algorithms/">Algorithms</a><small>4</small></li>
  
    <li><a href="/tags/Bayes-Inference/">Bayes Inference</a><small>1</small></li>
  
    <li><a href="/tags/CNN/">CNN</a><small>2</small></li>
  
    <li><a href="/tags/CS-Foundation/">CS Foundation</a><small>4</small></li>
  
    <li><a href="/tags/Convolution/">Convolution</a><small>1</small></li>
  
    <li><a href="/tags/Cosine/">Cosine</a><small>1</small></li>
  
    <li><a href="/tags/Coursera/">Coursera</a><small>4</small></li>
  
    <li><a href="/tags/DBN/">DBN</a><small>1</small></li>
  
    <li><a href="/tags/DCT/">DCT</a><small>1</small></li>
  
    <li><a href="/tags/DFT/">DFT</a><small>1</small></li>
  
    <li><a href="/tags/Deep-Learning/">Deep Learning</a><small>3</small></li>
  
    <li><a href="/tags/Dictionary-Learning/">Dictionary Learning</a><small>1</small></li>
  
    <li><a href="/tags/FC/">FC</a><small>2</small></li>
  
    <li><a href="/tags/Fitting/">Fitting</a><small>2</small></li>
  
    <li><a href="/tags/HMM/">HMM</a><small>1</small></li>
  
    <li><a href="/tags/Image-Restoration/">Image Restoration</a><small>1</small></li>
  
    <li><a href="/tags/Imagenet/">Imagenet</a><small>1</small></li>
  
    <li><a href="/tags/Leetcode/">Leetcode</a><small>1</small></li>
  
    <li><a href="/tags/MATLAB/">MATLAB</a><small>1</small></li>
  
    <li><a href="/tags/MNIST/">MNIST</a><small>1</small></li>
  
    <li><a href="/tags/NES/">NES</a><small>2</small></li>
  
    <li><a href="/tags/PCA/">PCA</a><small>3</small></li>
  
    <li><a href="/tags/Paper/">Paper</a><small>4</small></li>
  
    <li><a href="/tags/Processing/">Processing</a><small>5</small></li>
  
    <li><a href="/tags/Python/">Python</a><small>1</small></li>
  
    <li><a href="/tags/Sparse-Representation/">Sparse Representation</a><small>1</small></li>
  
    <li><a href="/tags/Statistics/">Statistics</a><small>1</small></li>
  
    <li><a href="/tags/Theano/">Theano</a><small>1</small></li>
  
    <li><a href="/tags/UFLDL/">UFLDL</a><small>7</small></li>
  
    <li><a href="/tags/Viterbi/">Viterbi</a><small>1</small></li>
  
    <li><a href="/tags/WeekEnd/">WeekEnd</a><small>1</small></li>
  
    <li><a href="/tags/fft/">fft</a><small>1</small></li>
  
    <li><a href="/tags/优先队列/">优先队列</a><small>0</small></li>
  
    <li><a href="/tags/分词/">分词</a><small>1</small></li>
  
    <li><a href="/tags/吉他/">吉他</a><small>1</small></li>
  
    <li><a href="/tags/喝酒/">喝酒</a><small>1</small></li>
  
    <li><a href="/tags/堆排序/">堆排序</a><small>0</small></li>
  
    <li><a href="/tags/排序/">排序</a><small>2</small></li>
  
    <li><a href="/tags/推荐系统/">推荐系统</a><small>1</small></li>
  
    <li><a href="/tags/最小二乘/">最小二乘</a><small>1</small></li>
  
    <li><a href="/tags/最近/">最近</a><small>1</small></li>
  
    <li><a href="/tags/树/">树</a><small>1</small></li>
  
    <li><a href="/tags/梯度下降/">梯度下降</a><small>1</small></li>
  
    <li><a href="/tags/正态分布/">正态分布</a><small>1</small></li>
  
    <li><a href="/tags/演出/">演出</a><small>1</small></li>
  
    <li><a href="/tags/爬虫/">爬虫</a><small>1</small></li>
  
    <li><a href="/tags/电影/">电影</a><small>2</small></li>
  
    <li><a href="/tags/矩阵分解/">矩阵分解</a><small>1</small></li>
  
    <li><a href="/tags/超级玛丽/">超级玛丽</a><small>2</small></li>
  
    <li><a href="/tags/马氏距离/">马氏距离</a><small>1</small></li>
  
    <li><a href="/tags/高斯/">高斯</a><small>2</small></li>
  
  </ul>
</div>

</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2015 Amnesia
  
</div>
<div class="clearfix"></div></footer>
  <script src="http://ajax.useso.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
<script src="/js/gallery.js"></script>




<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>




  <div
  class="fb-like"
  data-share="true"
  data-width="450"
  data-show-faces="true">
</div>
</body>
</html>